---
// MusicPlayer.astro
---

<section class="relative w-full py-8 md:py-20">
  <div class="max-w-2xl mx-auto px-6">
    
    <!-- Texto superior -->
    <div class="text-center mb-4">
      <p class="text-[#8FA58E] text-lg md:text-xl font-light font-charm">
        Dale Play para escuchar nuestra canci贸n.
      </p>
    </div>

    <!-- Reproductor -->
    <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 max-w-md mx-auto border border-[#C8A75A]/20" id="music-player-container">
      
      <!-- Controles del reproductor -->
      <div class="flex items-center gap-4">
        
        <!-- Bot贸n Play/Pause -->
        <button 
          id="playPauseBtn"
          class="flex-shrink-0 w-12 h-12 rounded-full bg-[#C8A75A]/10 hover:bg-[#C8A75A]/20 flex items-center justify-center transition-all duration-300 focus:outline-none"
        >
          <svg id="play-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-[#C8A75A] ml-1">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg id="pause-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-[#C8A75A] hidden">
            <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
          </svg>
        </button>

        <!-- Barra de progreso y tiempos -->
        <div class="flex-1">
          <div class="flex items-center gap-2 text-sm text-[#8FA58E] mb-2">
            <span id="currentTime" class="font-medium">0:00</span>
            <span class="text-[#8FA58E]">/</span>
            <span id="totalDuration" class="text-[#8FA58E]">0:00</span>
          </div>
          
          <!-- Barra de progreso -->
          <input
            type="range"
            id="progressBar"
            value="0"
            max="100"
            class="w-full h-1 bg-gray-200 rounded-full appearance-none cursor-pointer slider-custom"
          />
        </div>

        <!-- Bot贸n de volumen/opciones -->
        <button class="flex-shrink-0 w-10 h-10 rounded-full hover:bg-[#C8A75A]/10 flex items-center justify-center transition-all duration-300 focus:outline-none">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" class="text-[#8FA58E]">
            <path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
          </svg>
        </button>

      </div>

    </div>

  </div>
</section>

<!-- Audio element -->
<audio id="music-audio" preload="auto">
  <source src="/musica/melodia.mp3" type="audio/mpeg" />
  Tu navegador no soporta audio HTML5.
</audio>

<script>
  let isPlaying = false;
  let currentTime = 0;
  let duration = 0;

  document.addEventListener("DOMContentLoaded", () => {
    console.log(" Iniciando reproductor de m煤sica...");

    const playPauseBtn = document.getElementById("playPauseBtn");
    const progressBar = document.getElementById("progressBar");
    const audioElement = document.getElementById("music-audio");

    if (!(audioElement instanceof HTMLAudioElement)) {
      console.log("No se encontr贸 el elemento de audio");
      return;
    }

    // Obtener duraci贸n del audio
    audioElement.addEventListener("loadedmetadata", () => {
      duration = audioElement.duration;
      updateTimeDisplay();
      console.log(`Duraci贸n: ${Math.floor(duration / 60)}:${Math.floor(duration % 60).toString().padStart(2, "0")}`);
    });

    audioElement.addEventListener("canplaythrough", () => {
      if (duration === 0 && audioElement.duration) {
        duration = audioElement.duration;
        updateTimeDisplay();
      }
    });

    // Event Listeners
    if (playPauseBtn) {
      playPauseBtn.addEventListener("click", togglePlayPause);
    }

    if (progressBar) {
      progressBar.addEventListener("input", seekAudio);
    }

    // Funci贸n Play/Pause
    function togglePlayPause() {
      const playIcon = document.getElementById("play-icon");
      const pauseIcon = document.getElementById("pause-icon");

      if (!isPlaying) {
        audioElement.play().catch((error) => console.log("Error al reproducir:", error));

        if (playIcon) playIcon.classList.add("hidden");
        if (pauseIcon) pauseIcon.classList.remove("hidden");

        isPlaying = true;
        startProgress();
      } else {
        audioElement.pause();

        if (playIcon) playIcon.classList.remove("hidden");
        if (pauseIcon) pauseIcon.classList.add("hidden");

        isPlaying = false;
      }
    }

    // Buscar posici贸n en el audio
    function seekAudio() {
      if (!(progressBar instanceof HTMLInputElement)) return;

      const value = Number(progressBar.value) || 0;
      const seekTime = (value / 100) * audioElement.duration;

      audioElement.currentTime = seekTime;
      currentTime = seekTime;
      updateTimeDisplay();
    }

    // Iniciar progreso
    function startProgress() {
      const interval = setInterval(() => {
        if (!isPlaying) {
          clearInterval(interval);
          return;
        }

        currentTime = audioElement.currentTime;
        duration = audioElement.duration || duration;

        if (currentTime >= duration) {
          isPlaying = false;
          const playIcon = document.getElementById("play-icon");
          const pauseIcon = document.getElementById("pause-icon");
          if (playIcon) playIcon.classList.remove("hidden");
          if (pauseIcon) pauseIcon.classList.add("hidden");
          clearInterval(interval);
        }

        updateProgress();
      }, 100);
    }

    // Actualizar barra de progreso
    function updateProgress() {
      if (!(progressBar instanceof HTMLInputElement)) return;

      const progress = duration > 0 ? (currentTime / duration) * 100 : 0;
      progressBar.value = progress.toString();
      updateTimeDisplay();
    }

    // Actualizar tiempo mostrado
    function updateTimeDisplay() {
      const currentTimeEl = document.getElementById("currentTime");
      const totalDurationEl = document.getElementById("totalDuration");

      if (currentTimeEl) {
        const minutes = Math.floor(audioElement.currentTime / 60);
        const seconds = Math.floor(audioElement.currentTime % 60);
        currentTimeEl.textContent = `${minutes}:${seconds.toString().padStart(2, "0")}`;
      }

      if (totalDurationEl && audioElement.duration) {
        const totalMinutes = Math.floor(audioElement.duration / 60);
        const totalSeconds = Math.floor(audioElement.duration % 60);
        totalDurationEl.textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, "0")}`;
      } else if (totalDurationEl && duration > 0) {
        const totalMinutes = Math.floor(duration / 60);
        const totalSeconds = Math.floor(duration % 60);
        totalDurationEl.textContent = `${totalMinutes}:${totalSeconds.toString().padStart(2, "0")}`;
      }
    }
  });
</script>

<style>
  /* Para texto con Charm */
  .font-charm {
    font-family: 'Charm', cursive !important;
  }

  /* Estilo personalizado para la barra de progreso */
  .slider-custom {
    background: #e5e7eb;
    outline: none;
    border-radius: 10px;
  }

  .slider-custom::-webkit-slider-thumb {
    appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #C8A75A;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: all 0.3s ease;
  }

  .slider-custom::-webkit-slider-thumb:hover {
    transform: scale(1.2);
    box-shadow: 0 3px 8px rgba(200, 167, 90, 0.5);
  }

  .slider-custom::-moz-range-thumb {
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: #C8A75A;
    cursor: pointer;
    border: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  /* Animaci贸n del bot贸n play */
  #playPauseBtn:hover {
    transform: scale(1.05);
  }

  #playPauseBtn:active {
    transform: scale(0.95);
  }
</style>